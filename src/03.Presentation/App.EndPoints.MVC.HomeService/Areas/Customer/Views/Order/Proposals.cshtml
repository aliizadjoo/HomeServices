@using App.Domain.Core.Dtos.ProposalAgg
@using App.Domain.Core.Enums.ProposalAgg
@model List<ProposalSummaryDto>

@{
    ViewData["Title"] = "مدیریت پیشنهادها";
    var acceptedProposal = Model.FirstOrDefault(p => p.Status == ProposalStatus.Accepted);
    bool hasAccepted = acceptedProposal != null;
}

<div class="container py-5" dir="rtl">
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success">
            @TempData["SuccessMessage"]
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger">
            @TempData["ErrorMessage"]
        </div>
    }
    <div class="d-flex justify-content-between align-items-center mb-5 border-bottom pb-3">
        <h4 class="fw-bold text-dark">
            <i class="bi bi-person-gear ms-2 text-primary"></i>مدیریت پیشنهادهای سفارش #@ViewBag.OrderId
        </h4>
        <a asp-area="Customer" asp-controller="Order" asp-action="MyOrders" class="btn btn-outline-secondary btn-sm rounded-pill px-3">
            <i class="bi bi-arrow-right me-1"></i> بازگشت
        </a>
    </div>

    @if (hasAccepted)
    {
        <div class="alert alert-success border-0 shadow-sm rounded-4 mb-5 d-flex align-items-center p-3">
            <i class="bi bi-check-circle-fill fs-3 me-3"></i>
            <div>
                شما متخصص <strong>@acceptedProposal.ExpertFirstName @acceptedProposal.ExpertLastName</strong> را انتخاب کرده‌اید.
            </div>
        </div>
    }

    <div class="row g-4">
        @foreach (var item in Model)
        {
            <div class="col-md-6 col-lg-4">
                <div class="card h-100 shadow-sm border-0 rounded-4 @(item.Status == ProposalStatus.Accepted ? "border-2 border-success shadow" : "") @(item.Status == ProposalStatus.Rejected ? "opacity-75" : "")">
                    <div class="card-body p-4 d-flex flex-column">
                        <div class="d-flex justify-content-between mb-3">
                            <span class="badge @(item.Status == ProposalStatus.Accepted ? "bg-success" : (item.Status == ProposalStatus.Rejected ? "bg-danger" : "bg-light text-muted")) rounded-pill px-3 py-2">
                                @(item.Status == ProposalStatus.Accepted ? "تایید شده" : (item.Status == ProposalStatus.Rejected ? "رد شده" : "در انتظار"))
                            </span>
                            <div class="text-success fw-bold">
                                @item.Price.ToString("N0") <small>ریال</small>
                            </div>
                        </div>

                        <h6 class="fw-bold mb-1">@item.ExpertFirstName @item.ExpertLastName</h6>
                        <p class="text-muted small mb-3">
                            <i class="bi bi-calendar-check me-1"></i> تاریخ: @item.PersianExecutionDate
                        </p>

                        <div class="bg-light p-3 rounded-3 mb-4 flex-grow-1">
                            <small class="text-secondary">توضیحات متخصص:</small>
                            <p class="small mb-0 text-dark mt-1">@item.Description</p>
                        </div>

                        <div class="d-flex flex-column gap-2 mt-auto">
                            @if (item.Status == ProposalStatus.Accepted)
                            {
                               
                                <form asp-area="Customer" asp-controller="Order" asp-action="ChangeStatus"
                                      asp-route-proposalId="@item.Id" asp-route-newStatus="@ProposalStatus.Pending" asp-route-orderId="@ViewBag.OrderId"
                                      method="post">
                                    <button type="submit" class="btn btn-danger w-100 rounded-pill fw-bold py-2 shadow-sm">
                                        <i class="bi bi-arrow-counterclockwise me-1"></i> لغو انتخاب متخصص
                                    </button>
                                </form>
                            }
                            else if (item.Status == ProposalStatus.Rejected)
                            {
                                
                                <form asp-area="Customer" asp-controller="Order" asp-action="ChangeStatus"
                                      asp-route-proposalId="@item.Id" asp-route-newStatus="@ProposalStatus.Pending" asp-route-orderId="@ViewBag.OrderId"
                                      method="post">
                                    <button type="submit" class="btn btn-outline-secondary w-100 rounded-pill fw-bold py-2">
                                        <i class="bi bi-arrow-up-right-circle me-1"></i> بررسی مجدد این پیشنهاد
                                    </button>
                                </form>
                            }
                            else if (!hasAccepted)
                            {
                              
                                <div class="d-flex gap-2">
                                    <form asp-area="Customer" asp-controller="Order" asp-action="ChangeStatus"
                                          asp-route-proposalId="@item.Id" asp-route-newStatus="@ProposalStatus.Accepted" asp-route-orderId="@ViewBag.OrderId"
                                          method="post" class="flex-grow-1">
                                        <button type="submit" class="btn btn-success w-100 rounded-pill fw-bold py-2 shadow-sm">
                                            تایید متخصص
                                        </button>
                                    </form>

                                    <form asp-area="Customer" asp-controller="Order" asp-action="ChangeStatus"
                                          asp-route-proposalId="@item.Id" asp-route-newStatus="@ProposalStatus.Rejected" asp-route-orderId="@ViewBag.OrderId"
                                          method="post" class="flex-grow-1">
                                        <button type="submit" class="btn btn-outline-danger w-100 rounded-pill fw-bold py-2">
                                            رد کردن
                                        </button>
                                    </form>
                                </div>
                            }
                            else
                            {
                                
                                <button class="btn btn-light w-100 rounded-pill disabled small border text-muted py-2">
                                    غیر قابل انتخاب
                                </button>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>