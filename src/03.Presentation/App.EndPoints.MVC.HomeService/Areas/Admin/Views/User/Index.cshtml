@using App.EndPoints.MVC.HomeService.Areas.Admin.Models
@using App.EndPoints.MVC.HomeService.Extentions
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@model UserManagementViewModel

@{
    ViewData["Title"] = "مدیریت کاربران";
}

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-success fw-bold"><i class="bi bi-people-fill"></i> مدیریت جامع کاربران</h2>
        <a asp-action="Create" class="btn btn-success">
            <i class="bi bi-plus-circle"></i> افزودن کاربر جدید
        </a>
    </div>

 
    @if (ViewBag.CustomerError != null || ViewBag.ExpertError != null || ViewBag.AdminError != null)
    {
        <div class="alert alert-warning border-warning shadow-sm">
            <i class="bi bi-exclamation-triangle-fill"></i> برخی از داده‌ها به دلیل خطای سیستمی بارگذاری نشدند.
        </div>
    }

 
    <ul class="nav nav-tabs border-success" id="userTabs" role="tablist">
        <li class="nav-item">
            <button class="nav-link @(Model.ActiveTab == "customers" ? "active bg-success text-white" : "text-success") fw-bold"
                    id="customers-tab" data-bs-toggle="tab" data-bs-target="#customers" type="button">
                مشتریان <span class="badge @(Model.ActiveTab == "customers" ? "bg-white text-success" : "bg-success")">@Model.CustomerTotalCount</span>
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link @(Model.ActiveTab == "experts" ? "active bg-success text-white" : "text-success") fw-bold"
                    id="experts-tab" data-bs-toggle="tab" data-bs-target="#experts" type="button">
                کارشناسان <span class="badge @(Model.ActiveTab == "experts" ? "bg-white text-success" : "bg-success")">@Model.ExpertTotalCount</span>
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link @(Model.ActiveTab == "admins" ? "active bg-success text-white" : "text-success") fw-bold"
                    id="admins-tab" data-bs-toggle="tab" data-bs-target="#admins" type="button">
                مدیران <span class="badge @(Model.ActiveTab == "admins" ? "bg-white text-success" : "bg-success")">@Model.AdminTotalCount</span>
            </button>
        </li>
    </ul>

    <div class="tab-content border border-top-0 p-4 bg-white shadow-sm rounded-bottom">

        
        <div class="tab-pane fade @(Model.ActiveTab == "customers" ? "show active" : "")" id="customers">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>نام و خانوادگی</th>
                            <th>ایمیل</th>
                            <th>موجودی</th>
                            <th>تاریخ ثبت</th>
                            <th class="text-center">عملیات</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var c in Model.Customers)
                        {
                            <tr>
                                <td>@c.FirstName @c.LastName</td>
                                <td>@c.Email</td>
                                <td>@c.WalletBalance.ToString("N0") ریال</td>
                                <td>@c.CreatedAt.ToPersianDate()</td> 
                                <td class="text-center">
                                    <a asp-action="Edit" asp-route-id="@c.CustomerId" class="btn btn-sm btn-outline-primary">ویرایش</a>
                                    <form asp-action="Delete" asp-route-id="@c.CustomerId" method="post" class="d-inline" onsubmit="return confirm('حذف نرم انجام شود؟');">
                                        <button type="submit" class="btn btn-sm btn-outline-danger">حذف</button> @*  *@
                                    </form>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            @await Html.PartialAsync("_PaginationPartial", null, new ViewDataDictionary(ViewData) {
            { "TotalPages", Model.GetTotalPages(Model.CustomerTotalCount) },
                        { "CurrentPage", Model.CustomerPage },
                        { "ParamName", "cPageNumber" },
                        { "Others", $"&ePageNumber={Model.ExpertPage}&aPageNumber={Model.AdminPage}&activeTab=customers" }
                        })
        </div>

       
        <div class="tab-pane fade @(Model.ActiveTab == "experts" ? "show active" : "")" id="experts">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>نام</th>
                            <th>امتیاز</th>
                            <th>تخصص‌ها</th>
                            <th>تاریخ</th>
                            <th class="text-center">عملیات</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var e in Model.Experts)
                        {
                            <tr>
                                <td>@e.FirstName @e.LastName</td>
                                <td><span class="badge bg-warning text-dark">@e.AverageScore?.ToString("F1")</span></td>
                                <td><small>@string.Join(" | ", e.ServiceNames)</small></td>
                                <td>@e.CreatedAt.ToPersianDate()</td>
                                <td class="text-center">
                                    <a asp-action="Edit" asp-route-id="@e.ExpertId" class="btn btn-sm btn-outline-primary">ویرایش</a>
                                    <button class="btn btn-sm btn-outline-danger">حذف</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            @await Html.PartialAsync("_PaginationPartial", null, new ViewDataDictionary(ViewData) {
            { "TotalPages", Model.GetTotalPages(Model.ExpertTotalCount) },
                        { "CurrentPage", Model.ExpertPage },
                        { "ParamName", "ePageNumber" },
                        { "Others", $"&cPageNumber={Model.CustomerPage}&aPageNumber={Model.AdminPage}&activeTab=experts" }
                        })
        </div>

      
        <div class="tab-pane fade @(Model.ActiveTab == "admins" ? "show active" : "")" id="admins">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>نام</th>
                            <th>کد پرسنلی</th>
                            <th>درآمد کل</th>
                            <th class="text-center">عملیات</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var a in Model.Admins)
                        {
                            <tr>
                                <td>@a.FirstName @a.LastName</td>
                                <td class="fw-bold text-success">@a.StaffCode</td>
                                <td>@a.TotalRevenue.ToString("N0")</td>
                                <td class="text-center">
                                    <a asp-action="Edit" asp-route-id="@a.AdminId" class="btn btn-sm btn-outline-primary">ویرایش</a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            @await Html.PartialAsync("_PaginationPartial", null, new ViewDataDictionary(ViewData) {
            { "TotalPages", Model.GetTotalPages(Model.AdminTotalCount) },
                        { "CurrentPage", Model.AdminPage },
                        { "ParamName", "aPageNumber" },
                        { "Others", $"&cPageNumber={Model.CustomerPage}&ePageNumber={Model.ExpertPage}&activeTab=admins" }
                        })
        </div>
    </div>
</div>